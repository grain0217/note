### 1. HTTP/1.X 的缺陷
虽然HTTP/1.x 采取了很多优化资源加载速度的策略，取得了一些效果，但是HTTP/1.x 对带宽的利用率并不理想，主要表现在以下几点：

#### 1.1 TCP连接复用问题
TCP连接无法被复用会导致每次HTTP请求要经历TCP的三次握手：
- HTTP/1.0 传输数据时，每一次通信都要建立TCP连接
- HTTP/1.1 加入了`Keep-alive`使得TCP连接可以被复用，但是在处理多个请求时，每个请求要等到它之前的请求响应完才能**被发起**。
 
HTTP/1.1规范中又约定了`Pipelining`来试图解决TCP连接复用的问题——一个支持持久连接的客户端可以在一个TCP连接中发送多个请求（不需要等待任意请求的响应），但是**服务端必须按照请求收到的顺序发送响应**：

![Pipelining](https://img.imgdb.cn/item/601acd383ffa7d37b3132c15.jpg)

`Pipelining`在实践中有诸多问题：
- 一些代理服务器不能正确处理`Pipelining`
- 正确的流水线的实现很复杂
- 队头阻塞问题

现代浏览器默认是不开启`HTTP pipelining`的。

#### 1.2 队头阻塞（HOLB）
如图，假设在一个TCP连接上有5个HTTP请求同时发出：

![HOLB](https://img.imgdb.cn/item/601983313ffa7d37b3971eae.jpg)

- 如果没有开启`pipelining`，在请求1没有收到响应之前，后续的请求只能排队，请求2，3，4，5只能等待收到请求1的响应之后才能逐个发出
- 即使开启了`pipelining`，由于服务端需要请求按照的顺序依次响应结果请求，如果服务器在处理请求1时花费了大量时间，那么后面所有的请求都需要在请求1被响应完成后才能得到处理

可见`Pipelining`只能**解决部分**HOLB问题。

#### 1.3 协议开销
在HTTP/1.x中，数据的传输是**基于文本**的：

![HTTP/1.x 报文格式](https://img.imgdb.cn/item/6036785c5f4313ce259900de.png)

如图所示为HTTP/1.x的一个请求报文格式，以换行符分隔每一个HTTP头字段，服务端通过分隔符来解析数据，这存在几个问题：
1. 一次只能处理一个请求/响应，服务端以分隔符解析数据，在完成之前无法停止
2. 数据的体积无法预知，服务端不知道应该将多大的内容放到内存中解析

另一方面，HTTP头携带的内容过大，许多固定字段（如`User Agent`、`Cookie`、`Accept`）是基本不怎么变化的，这在一定程度上也会造成传输的成本的浪费。

#### 1.4 安全性
HTTP/1.x在传输数据时，所有传输的内容都是明文，客户端和服务器端都无法验证对方的身份，这在一定程度上无法保证数据的安全性。

### 2. HTTP/2
针对HTTP/1.x 中存在的诸多问题，HTTP/2 从以下几个方面做了优化工作：

#### 2.1 二进制分帧实现多路复用
不同于HTTP/1.x 所采用的的基于文本的数据传输，HTTP/2 将请求/响应的数据分割为更小的帧，并且它们采用二进制编码：

![HTTP/2 分帧](https://img.imgdb.cn/item/606099e68322e6675c18f49b.jpg)

客户端将请求经过二进制分帧后，发送的是一堆乱序的帧（不同流的帧是乱序的，同一条流的帧是顺序传输的），服务端在接收到帧后将流标识相同的帧合并为一条完整的请求信息。

利用二进制分帧，浏览器对同一个域名下的请求/响应，只建立一个TCP连接，减少了由于TCP握手、慢启动而消耗的时间。

#### 2.2 头部压缩
HTTP/2 使用`HPACK`压缩算法对请求头和响应头进行压缩：
1. 在客户端和服务器端使用索引列表来维护和更新之前看到的HTTP头字段，对于相同的头部，不再通过每次请求和响应发送
2. 索引列表在HTTP/2 的连接存续期内始终存在，由客户端和服务端共同渐进更新
3. 每个新的头部键值对要么被追加到当前表的末尾，要么替换掉表中已经存在的

#### 2.3 服务端推送
服务端可以在发送页面HTML时主动推送其它资源，而不用等到浏览器解析到相应位置，发起请求再响应。例如服务端可以主动把JavaScript脚本和CSS文件推送给客户端，而不需要客户端解析HTML时再发送这些请求。

服务端可以主动推送，客户端也有权利选择是否接收。如果服务端推送的资源已经被浏览器缓存过，浏览器可以通过发送`RST_STREAM`帧来拒收。主动推送也遵守同源策略，服务器不会随便推送第三方资源给客户端。

更多关于`Server Push`的信息可以阅读以下文章：
1. [Introducing HTTP/2 Server Push with NGINX 1.13.9](https://www.nginx.com/blog/nginx-1-13-9-http2-server-push/)
2. [A Comprehensive Guide To HTTP/2 Server Push](https://www.smashingmagazine.com/2017/04/guide-http2-server-push/)

___
### 参考
1. [HTTP/2相比HTTP/1.x有哪些重大改进？](https://www.zhihu.com/question/34074946)
2. [6分钟了解HTTP发展史](https://mp.weixin.qq.com/s/UMoaXVTi7grsTiyR8bngww)
3. [让互联网更快，Server Push 特性及开启方式详解](https://www.upyun.com/tech/article/294/1.html)
